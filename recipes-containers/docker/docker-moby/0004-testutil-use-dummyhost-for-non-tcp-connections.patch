From ba259d6bd75b15bd4f836bd2d26d72fb73a80d3f Mon Sep 17 00:00:00 2001
From: Sebastiaan van Stijn <github@gone.nl>
Date: Wed, 12 Jul 2023 17:37:01 +0200
Subject: [PATCH 4/4] testutil: use dummyhost for non-tcp connections

Signed-off-by: Sebastiaan van Stijn <github@gone.nl>
(cherry picked from commit e1db9e9848435042922512b3b5f6dc97f627af00)
Signed-off-by: Sebastiaan van Stijn <github@gone.nl>

Upstream-Status: Backport [ba259d6bd75b15bd4f836bd2d26d72fb73a80d3f]

Signed-off-by: Chen Qi <Qi.Chen@windriver.com>
---
 integration-cli/docker_api_attach_test.go | 5 +++++
 testutil/request/request.go               | 5 +++++
 2 files changed, 10 insertions(+)

diff --git a/integration-cli/docker_api_attach_test.go b/integration-cli/docker_api_attach_test.go
index 2f20b59eed..4c803b762a 100644
--- a/integration-cli/docker_api_attach_test.go
+++ b/integration-cli/docker_api_attach_test.go
@@ -237,6 +237,11 @@ func requestHijack(method, endpoint string, data io.Reader, ct, daemon string, m
 	req.URL.Scheme = "http"
 	req.URL.Host = hostURL.Host
 
+	if hostURL.Scheme == "unix" || hostURL.Scheme == "npipe" {
+		// Override host header for non-tcp connections.
+		req.Host = client.DummyHost
+	}
+
 	for _, opt := range modifiers {
 		opt(req)
 	}
diff --git a/testutil/request/request.go b/testutil/request/request.go
index d5f559c666..6a91dc9b37 100644
--- a/testutil/request/request.go
+++ b/testutil/request/request.go
@@ -125,6 +125,11 @@ func newRequest(endpoint string, opts *Options) (*http.Request, error) {
 	}
 	req.URL.Host = hostURL.Host
 
+	if hostURL.Scheme == "unix" || hostURL.Scheme == "npipe" {
+		// Override host header for non-tcp connections.
+		req.Host = client.DummyHost
+	}
+
 	for _, config := range opts.requestModifiers {
 		if err := config(req); err != nil {
 			return nil, err
-- 
2.40.0

